<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Shooting Game</title>
  <style>
    body {
      margin: 0;
      background: #000;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      overflow: hidden;
      touch-action: none;
    }
    canvas {
      background: #111;
      display: block;
    }
    #retryBtn {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      display: none;
      padding: 12px 25px;
      font-size: 22px;
      border-radius: 10px;
      border: none;
      background: #fff;
    }
  </style>
</head>
<body>
  <canvas id="game"></canvas>
  <button id="retryBtn">Play Again</button>

  <script>
    const canvas = document.getElementById("game");
    const ctx = canvas.getContext("2d");
    const retryBtn = document.getElementById("retryBtn");

    function resizeCanvas() {
      if (window.innerWidth >= 600) {
        canvas.width = 400;
        canvas.height = 600;
      } else {
        const w = window.innerWidth * 0.9;
        const h = w * 1.5;
        canvas.width = w;
        canvas.height = h;
      }
    }
    resizeCanvas();
    window.addEventListener("resize", resizeCanvas);

    const titleImg = new Image();
    titleImg.src = "title.png";
    const startImg = new Image();
    startImg.src = "start.png";
    const playerImg = new Image();
    playerImg.src = "player.png";
    const gameoverImg = new Image();
    gameoverImg.src = "gameover.png";
    const score30Img = new Image();
    score30Img.src = "score30.png";
    const score40Img = new Image();
    score40Img.src = "score40.png";
    const score50Img = new Image();
    score50Img.src = "score50.png";

    const titleBgm = new Audio("title.mp3");
    titleBgm.loop = true;
    titleBgm.volume = 0.6;

    const gameBgm = new Audio("game.mp3");
    gameBgm.loop = true;
    gameBgm.volume = 0.6;

    const GAME_TIME = 60;
    const COOLDOWN = 300;

    let screen = "tap";
    let score = 0;
    let life = 5;
    let startTime = 0;
    let canShoot = true;
    let isGameOver = false;

    let player = { x: canvas.width / 2, y: canvas.height - 70 };
    let bullets = [];
    let enemyBullets = [];

    function resetGame() {
      score = 0;
      life = 5;
      startTime = Date.now();
      canShoot = true;
      isGameOver = false;
      bullets = [];
      enemyBullets = [];
      player.x = canvas.width / 2;
      player.y = canvas.height - 70;
    }

    function startGame(fromRetry) {
      screen = "playing";
      resetGame();
      titleBgm.pause();
      titleBgm.currentTime = 0;
      gameBgm.currentTime = 0;
      gameBgm.play();
      retryBtn.style.display = "none";
      if (fromRetry) {
        enemyBullets = [];
      }
    }

    function stopGame() {
      isGameOver = true;
      screen = "gameOver";
      gameBgm.pause();
      retryBtn.style.display = "block";
    }

    function advanceScreen() {
      if (screen === "tap") {
        screen = "title";
        titleBgm.currentTime = 0;
        titleBgm.play();
      } else if (screen === "title") {
        screen = "rules";
      } else if (screen === "rules") {
        screen = "controls";
      } else if (screen === "controls") {
        screen = "credits";
      } else if (screen === "credits") {
        screen = "startPrompt";
      } else if (screen === "startPrompt") {
        startGame(false);
      }
    }

    function shoot() {
      if (!canShoot || isGameOver || screen !== "playing") return;
      bullets.push({ x: player.x, y: player.y });
      canShoot = false;
      setTimeout(() => { canShoot = true; }, COOLDOWN);
    }

    document.addEventListener("mousemove", (e) => {
      if (screen !== "playing") return;
      const rect = canvas.getBoundingClientRect();
      player.x = e.clientX - rect.left;
    });

    document.addEventListener("click", (e) => {
      if (screen === "playing") {
        shoot();
      } else if (screen !== "gameOver") {
        advanceScreen();
      }
    });

    canvas.addEventListener("touchmove", (e) => {
      if (screen !== "playing") return;
      e.preventDefault();
      const rect = canvas.getBoundingClientRect();
      const t = e.touches[0];
      player.x = t.clientX - rect.left;
    }, { passive: false });

    canvas.addEventListener("touchstart", (e) => {
      e.preventDefault();
      if (screen === "playing") {
        shoot();
      } else if (screen !== "gameOver") {
        advanceScreen();
      }
    }, { passive: false });

    retryBtn.addEventListener("click", () => {
      startGame(true);
    });

    setInterval(() => {
      if (screen === "playing" && !isGameOver) {
        enemyBullets.push({
          x: Math.random() * (canvas.width - 20) + 10,
          y: 0,
          size: 10,
          speed: 3 + Math.random() * 2
        });
      }
    }, 1000);

    function drawCenteredImage(img, maxSize) {
      const size = Math.min(maxSize, canvas.width * 0.9, canvas.height * 0.9);
      const x = (canvas.width - size) / 2;
      const y = (canvas.height - size) / 2;
      ctx.drawImage(img, x, y, size, size);
    }

    function drawMultilineText(lines) {
      ctx.fillStyle = "white";
      ctx.font = "16px Arial";
      ctx.textAlign = "left";
      const lineHeight = 28;
      let y = canvas.height / 2 - (lines.length * lineHeight) / 2;
      const x = canvas.width * 0.1;
      for (const line of lines) {
        ctx.fillText(line, x, y);
        y += lineHeight;
      }
    }

    function updateGame() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      if (player.x < 20) player.x = 20;
      if (player.x > canvas.width - 20) player.x = canvas.width - 20;

      let elapsed = (Date.now() - startTime) / 1000;
      let remaining = Math.max(0, GAME_TIME - Math.floor(elapsed));

      if (remaining <= 0 && !isGameOver) {
        stopGame();
      }

      ctx.drawImage(playerImg, player.x - 20, player.y - 20, 40, 40);

      ctx.fillStyle = "yellow";
      bullets.forEach((b, i) => {
        b.y -= 5;
        ctx.fillRect(b.x - 2, b.y, 4, 10);
        if (b.y < 0) bullets.splice(i, 1);
      });

      ctx.fillStyle = "red";
      enemyBullets.forEach((eb, i) => {
        eb.y += eb.speed;
        ctx.beginPath();
        ctx.arc(eb.x, eb.y, eb.size, 0, Math.PI * 2);
        ctx.fill();

        if (eb.y > canvas.height) enemyBullets.splice(i, 1);

        if (Math.abs(player.x - eb.x) < 20 &&
            Math.abs(player.y - eb.y) < 20) {
          life--;
          enemyBullets.splice(i, 1);
          if (life <= 0 && !isGameOver) {
            stopGame();
          }
        }

        bullets.forEach((b, bi) => {
          if (Math.abs(b.x - eb.x) < 10 &&
              Math.abs(b.y - eb.y) < 10) {
            score++;
            bullets.splice(bi, 1);
            enemyBullets.splice(i, 1);
          }
        });
      });

      ctx.fillStyle = "white";
      ctx.textAlign = "left";
      ctx.font = "24px Arial";
      ctx.fillText("Time: " + remaining, 20, 30);
      ctx.fillText("Life: " + life, 20, 60);

      ctx.textAlign = "right";
      ctx.fillText("Score: " + score, canvas.width - 20, 30);

      ctx.textAlign = "right";
      ctx.font = "14px Arial";
      ctx.fillText("@pierre_log", canvas.width - 10, canvas.height - 10);
    }

    function drawGameOver() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      let img;
      if (life <= 0) {
        img = gameoverImg;
      } else if (score < 30) {
        img = score30Img;
      } else if (score < 50) {
        img = score40Img;
      } else {
        img = score50Img;
      }
      drawCenteredImage(img, Math.min(canvas.width * 0.8, canvas.height * 0.8));
    }

    function drawTapScreen() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.fillStyle = "white";
      ctx.textAlign = "center";
      ctx.font = "40px Arial";
      ctx.fillText("TAP!", canvas.width / 2, canvas.height / 2);
    }

    function draw() {
      if (screen === "tap") {
        drawTapScreen();
      } else if (screen === "title") {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        drawCenteredImage(titleImg, 450);
      } else if (screen === "rules") {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        drawMultilineText([
          "◾︎ルール",
          "前方から飛んでくる赤い弾を、",
          "左右に避けながら撃ち落とそう！",
          "",
          "赤い弾に当たるとライフが1減ります。",
          "ライフは5つ。",
          "すべて失うとゲームオーバーです。",
          "",
          "▶︎次のページ"
        ]);
      } else if (screen === "controls") {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        drawMultilineText([
          "■操作方法",
          "・スマホ",
          "  移動：指を画面に置いたまま",
           "       左右にスライド",
          "  発射：別の指で画面タップ",
          "",
          "・PC",
          "  移動：マウス",
          "  発射：左クリック",
          "",
          "▶︎次のページ"
        ]);
      } else if (screen === "credits") {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        drawMultilineText([
 "◾︎使用させていただいた音源",
  "",
  "タイトル・ルール画面BGM：",
  "北見ヒツジ様「Lame SPY」",
  "",
  "ゲームBGM：",
  "ザイオン様「The Swing of Time」",
  "",
  "音源提供：フリーBGM",
  "DOVA-SYNDROME 様",
  "",
  "▶︎次のページ"
        ]);
      } else if (screen === "startPrompt") {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        drawCenteredImage(startImg, 450);
      } else if (screen === "playing") {
        updateGame();
      } else if (screen === "gameOver") {
        drawGameOver();
      }

      requestAnimationFrame(draw);
    }

    draw();
  </script>
</body>
</html>
